const fetchContents = require('./spiderCore')
const fs = require('fs')
const cheerio = require('cheerio')
const fetch = require('./GetDetail')
const xlsx = require('node-xlsx')
const moment = require('moment')
const path = require('path')

async function begin () {
  const links = []
  for (let page = 1; page <= 11; page++) {
    let formData = `__VIEWSTATE=%2FwEPDwUJNjkzNzgyNTU4D2QWAmYPZBYIZg9kFgICAQ9kFgJmDxYCHgdWaXNpYmxlaGQCAQ9kFgICAQ8WAh4Fc3R5bGUFJkJBQ0tHUk9VTkQtQ09MT1I6NWZiM2U0O0NPTE9SOiNGRkZGRkY7ZAICD2QWAgIBD2QWAmYPZBYCZg9kFgJmD2QWBGYPZBYCZg9kFgJmD2QWAmYPZBYEZg9kFgJmDxYEHwEFIENPTE9SOiNEM0QzRDM7QkFDS0dST1VORC1DT0xPUjo7HwBoFgJmD2QWAgIBD2QWAmYPDxYCHgRUZXh0ZWRkAgIPZBYCZg9kFgICAg9kFgJmD2QWAmYPZBYCZg9kFgJmD2QWAgIBD2QWAmYPFgQfAQUgQ09MT1I6I0QzRDNEMztCQUNLR1JPVU5ELUNPTE9SOjsfAGgWAmYPZBYCAgEPZBYCZg8PFgIfAmVkZAIBD2QWAmYPZBYCZg9kFgJmD2QWBGYPZBYCZg8WBB8BBSBDT0xPUjojRDNEM0QzO0JBQ0tHUk9VTkQtQ09MT1I6Ox8AaBYCZg9kFgICAQ9kFgJmDw8WAh8CZWRkAgIPZBYCZg9kFgICAg9kFgJmD2QWAmYPZBYCZg9kFgJmD2QWBGYPZBYCZg8WBB8BBX9DT0xPUjojMDAwMDAwO0JBQ0tHUk9VTkQtQ09MT1I6O0JBQ0tHUk9VTkQtSU1BR0U6dXJsKGh0dHA6Ly93d3cubGFuZGdkLmNvbS8vVXNlci9kZWZhdWx0L1VwbG9hZC9zeXNGcmFtZUltZy94Z2RfenlfY2pnc18xLmdpZik7HgZoZWlnaHQFAjM1FgJmD2QWAgIBD2QWAmYPDxYCHwJlZGQCAg9kFgJmD2QWAmYPZBYEZg9kFgJmD2QWAmYPZBYCZg9kFgICAQ9kFgJmDxYEHwEFJ0NPTE9SOiNEM0QzRDM7QkFDS0dST1VORC1DT0xPUjojZmZmZmNkOx8AaBYCZg9kFgICAQ9kFgJmDw8WAh8CZWRkAgEPZBYCZg9kFgJmD2QWAmYPZBYEAgEPZBYCZg8WBB8BBSdDT0xPUjojRDNEM0QzO0JBQ0tHUk9VTkQtQ09MT1I6I2ZmZmZjZDsfAGgWAmYPZBYCAgEPZBYCZg8PFgIfAmVkZAIDD2QWAmYPZBYEAgUPDxYCHgtSZWNvcmRjb3VudAKerAJkZAINDxYEHwEFDWRpc3BsYXk6bm9uZTseCWlubmVyaHRtbAXgBjxhIGhyZWY9Ii9EZXNrdG9wRGVmYXVsdC5hc3B4P3RhYmlkPTIyMyZwYWdlPTEiPummlumhtTwvYT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPuS4iumhtTwvYT48YSBocmVmPSIvRGVza3RvcERlZmF1bHQuYXNweD90YWJpZD0yMjMmcGFnZT0xIj7nrKwx6aG1PC9hPjxhIGhyZWY9Ii9EZXNrdG9wRGVmYXVsdC5hc3B4P3RhYmlkPTIyMyZwYWdlPTIiPuesrDLpobU8L2E%2BPGEgaHJlZj0iL0Rlc2t0b3BEZWZhdWx0LmFzcHg%2FdGFiaWQ9MjIzJnBhZ2U9MyI%2B56ysM%2BmhtTwvYT48YSBocmVmPSIvRGVza3RvcERlZmF1bHQuYXNweD90YWJpZD0yMjMmcGFnZT00Ij7nrKw06aG1PC9hPjxhIGhyZWY9Ii9EZXNrdG9wRGVmYXVsdC5hc3B4P3RhYmlkPTIyMyZwYWdlPTUiPuesrDXpobU8L2E%2BPGEgaHJlZj0iL0Rlc2t0b3BEZWZhdWx0LmFzcHg%2FdGFiaWQ9MjIzJnBhZ2U9NiI%2B56ysNumhtTwvYT48YSBocmVmPSIvRGVza3RvcERlZmF1bHQuYXNweD90YWJpZD0yMjMmcGFnZT03Ij7nrKw36aG1PC9hPjxhIGhyZWY9Ii9EZXNrdG9wRGVmYXVsdC5hc3B4P3RhYmlkPTIyMyZwYWdlPTgiPuesrDjpobU8L2E%2BPGEgaHJlZj0iL0Rlc2t0b3BEZWZhdWx0LmFzcHg%2FdGFiaWQ9MjIzJnBhZ2U9OSI%2B56ysOemhtTwvYT48YSBocmVmPSIvRGVza3RvcERlZmF1bHQuYXNweD90YWJpZD0yMjMmcGFnZT0xMCI%2B56ysMTDpobU8L2E%2BPGEgaHJlZj0iL0Rlc2t0b3BEZWZhdWx0LmFzcHg%2FdGFiaWQ9MjIzJnBhZ2U9MTEiPi4uLjwvYT48YSBocmVmPSIvRGVza3RvcERlZmF1bHQuYXNweD90YWJpZD0yMjMmcGFnZT0yIj7kuIvpobU8L2E%2BPGEgaHJlZj0iL0Rlc2t0b3BEZWZhdWx0LmFzcHg%2FdGFiaWQ9MjIzJnBhZ2U9MTI4MSI%2B5bC%2B6aG1PC9hPmQCAw9kFgICAw8WBB8FBcAKPHRhYmxlIHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7IHdpZHRoOiAxMDAlOyBjb2xvcjogIzgwODA4MDsgZm9udC1zaXplOiAxMnB4OyB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlIj4NCiAgICA8dGJvZHk%2BDQogICAgICAgIDx0cj4NCiAgICAgICAgICAgIDx0ZD48dT48Zm9udCBjb2xvcj0iIzAwNjZjYyI%2BPGJyIC8%2BDQogICAgICAgICAgICA8L2ZvbnQ%2BPC91PjxhIGhyZWY9Imh0dHA6Ly93d3cubGFuZGdkLmNvbS9tYW5hZ2VyIj7lub%2FkuJznnIHlnJ%2FlnLDluILlnLrnvZE8L2E%2BPC90ZD4NCiAgICAgICAgPC90cj4NCiAgICAgICAgICAgICAgICA8dHI%2BDQogICAgICAgICAgICA8dGQ%2B57u05oqk5Y2V5L2N77ya5bm%2F5Lic55yB5Zyf5Zyw5byA5Y%2BR5YKo5aSH5bGAPC90ZD4NCiAgICAgICAgPC90cj4NCiAgICAgICAgPHRyPg0KICAgICAgICAgICAgPHRkPue7tOaKpOS%2Foeeuse%2B8mmFkbWlu77ygbGFuZGdkLmNvbTwvdGQ%2BDQogICAgICAgIDwvdHI%2BDQogICAgICAgIDx0cj4NCiAgICAgICAgICAgIDx0ZD7lu7rorq7kvb%2FnlKhJReaIluWFtuS7luWFvOWuuea1j%2BiniOWZqOa1j%2BiniCzkvb%2FnlKgxMDI0Kjc2OOS7peS4iuWIhui%2BqOeOhzwvdGQ%2BDQogICAgICAgIDwvdHI%2BDQogICAgICAgIDx0cj4NCiAgICAgICAgICAgIDx0ZD48YSB0YXJnZXQ9Il9ibGFuayIgaHJlZj0iaHR0cDovL3d3dy5taWliZWlhbi5nb3YuY24vIj7nsqRJQ1DlpIcwOTIyMzU1NuWPtzwvYT4gPGJyIC8%2BDQogICAgICAgICAgICAmbmJzcDs8L3RkPg0KICAgICAgICA8L3RyPg0KICAgIDwvdGJvZHk%2BDQo8L3RhYmxlPg0KPCEtLUdPT0dMRS0tPjxTQ1JJUFQgdHlwZT10ZXh0L2phdmFzY3JpcHQ%2BDQogIHZhciBfZ2FxID0gX2dhcSB8fCBbXTsNCiAgX2dhcS5wdXNoKFsnX3NldEFjY291bnQnLCAnVUEtMjcxMjY1OTgtMSddKTsNCiAgX2dhcS5wdXNoKFsnX3NldERvbWFpbk5hbWUnLCAnbGFuZGdkLmNvbSddKTsNCiAgX2dhcS5wdXNoKFsnX3RyYWNrUGFnZXZpZXcnXSk7DQogIChmdW5jdGlvbigpIHsNCiAgICB2YXIgZ2EgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsgZ2EudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnOyBnYS5hc3luYyA9IHRydWU7DQogICAgZ2Euc3JjID0gKCdodHRwczonID09IGRvY3VtZW50LmxvY2F0aW9uLnByb3RvY29sID8gJ2h0dHBzOi8vc3NsJyA6ICdodHRwOi8vd3d3JykgKyAnLmdvb2dsZS1hbmFseXRpY3MuY29tL2dhLmpzJzsNCiAgICB2YXIgcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKVswXTsgcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZShnYSwgcyk7DQogIH0pKCk7DQo8L1NDUklQVD48IS0tR09PR0xFLS0%2BHwEFYEJBQ0tHUk9VTkQtSU1BR0U6dXJsKGh0dHA6Ly93d3cubGFuZGdkLmNvbS8vVXNlci9kZWZhdWx0L1VwbG9hZC9zeXNGcmFtZUltZy94Z2Rfc2N3X3l3dHBfMS5qcGcpO2QYAQUeX19Db250cm9sc1JlcXVpcmVQb3N0QmFja0tleV9fFgUFLW1haW5Nb2R1bGVDb250YWluZXI6NDg3OjQ5MDo0OTE6X2N0bDA6dGFnMV84NAUtbWFpbk1vZHVsZUNvbnRhaW5lcjo0ODc6NDkwOjQ5MTpfY3RsMDp0YWcxXzgzBS5tYWluTW9kdWxlQ29udGFpbmVyOjQ4Nzo0OTA6NDkxOl9jdGwwOnRhZzFfMTEyBS5tYWluTW9kdWxlQ29udGFpbmVyOjQ4Nzo0OTA6NDkxOl9jdGwwOnRhZzFfMTEzBTJtYWluTW9kdWxlQ29udGFpbmVyOjQ4Nzo0OTA6NDkxOl9jdGwwOnRhZzFfU09SVF8xOXPSuysc4AmG1mOa6fx6sIwJukxCmwiX%2FfJodxKZyy70&__VIEWSTATEGENERATOR=DEAEDF11&__EVENTTARGET=&__EVENTARGUMENT=${page}&__EVENTVALIDATION=%2FwEdABQ0whFiyewX%2BOxx%2BdfALZhkCeA4P5qp%2BtM6YGffBqgTjX5BBRi8Q0dS3RFtz1f1RlzUG4Dk6H6qEBl0E7hUmrSqpqAef7%2BvQQ3CeCWRrGnOWs76d3s3bfVAbPv%2BC2x9aI4KNdaFIY7vnH0Pst%2FbRmjNlPuFBYUlptFG90cAbG9XdC5mvH1mddpKFJ8RxLHaP8RGiN%2FmBOSnKLIU1LXHJthbggksuBty4H0Slse8cAjOhQkr0QmRbsrattySt4n0H7rsfiOL8A6vVEvbe9tHQdd8%2BYQ8ZJt3pvB5CbTpmPrG8WPU62r1OgUTvjKJFfM7b9IvXEAPOE2Q6UT0b3%2Bzj213HuR9DHJh5%2FWQVm2jKFP7pGxQmstRdZpNwwYWR6PMDxXdZH2p6C9TNSgJofr8a3PcQL1%2BihtMgv8KoNSQboaljU1%2BzR67YTeLbeB6ktIvA1KDe1%2FnVyrfr%2FOYNQsXr%2BZX&hidComName=default&mainModuleContainer%3A483%3A486%3AtxtKeyWord=%C7%EB%CA%E4%C8%EB%B9%D8%BC%FC%B4%CA&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_84_txt0=&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_84_txt1=&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_83_en=&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_83_env=&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_112_txt0=&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_112_txt1=&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_113=1&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_113_en=%B6%AB%DD%B8%CA%D0&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_113_env=4419&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_SORT_19=False&mainModuleContainer%3A487%3A490%3A491%3A_ctl0%3Atag1_Query=%B2%E9%D1%AF&mainModuleContainer%3A487%3A490%3A492%3A_ctl0%3ASortColumn=&mainModuleContainer%3A487%3A490%3A492%3A_ctl0%3AAspNetPager1_input=1&mainModuleContainer%3A487%3A490%3A492%3A_ctl0%3AAspNetPager1_value=38430`
    let contents = await fetchContents({ options: {}, formData })
    const $ = cheerio.load(contents)
    const trs = $('#mainModuleContainer_487_490_492__ctl0_contentTable').find('tr')
    trs.each(function (i, el) {
      if (i !== 0) {
        links.push($(el).find('a').attr('href'))
      }
    })
  }
  const data = await fetch(links, 5)
  var xlsData = [{
    name: 'sheet1',
    data: [
      ['发布时间', '宗地编号', '地块位置', '土地用途', '土地面积(公顷)', '出让年限', '成交价(万元)', '受让单位']
    ]
  }]
  data.forEach(d => {
    xlsData[0].data.push([
      d.date,
      d.number,
      d.address,
      d.type,
      d.area,
      d.limit,
      d.price,
      d.company
    ])
  })
  const file = xlsx.build(xlsData)
  fs.writeFileSync(path.resolve(__dirname, `../output/${moment().format('YYYY-MM-DD HH-mm')}.xlsx`), file, 'binary')
}

begin()